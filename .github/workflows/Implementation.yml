name: Implementation

on:
  push:
  pull_request:
  schedule:
    - cron: '0 0 * * 5'
  workflow_dispatch:

jobs:


  Matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}

    steps:

    - name: 'ğŸ§° Repository Checkout'
      uses: actions/checkout@v5

    - name: 'ğŸ”§ Generate examples matrix'
      id: generate
      run: ./.github/generate-job-matrix.py


  All-in-one:
    needs: Matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.Matrix.outputs.matrix) }}
    name: 'ğŸ›³ï¸ All-in-one | ${{ matrix.board }} Â· ${{ matrix.design }}'

    steps:

    - name: 'ğŸ§° Repository Checkout'
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        submodules: recursive

    - name: 'ğŸš§ Generate ${{ matrix.board }} ${{ matrix.design }} bitstream'
      uses: docker://ghcr.io/stnolting/neorv32/impl
      with:
        args: make -C osflow BOARD=${{ matrix.board }} ${{ matrix.design }}

    - name: 'ğŸ“¤ Upload Artifact: ${{ matrix.board }} ${{ matrix.design }} bitstream and reports'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.board }}-${{ matrix.design }}
        path: |
          osflow/${{ matrix.bitstream }}
          osflow/${{ matrix.board }}/*-report.txt


# Windows:
#   needs: Matrix
#   runs-on: windows-latest
#   strategy:
#     fail-fast: false
#     matrix:
#       include: ${{ fromJson(needs.Matrix.outputs.matrix) }}
#   name: 'ğŸŸ¦ MINGW64 | ${{ matrix.board }} Â· ${{ matrix.design }}'
#   defaults:
#     run:
#       shell: msys2 {0}
#   steps:
#
#   - name: 'ğŸŸ¦ Setup MSYS2'
#     uses: msys2/setup-msys2@v2
#     with:
#       msystem: MINGW64
#       update: true
#       install: make
#       pacboy: >
#         yosys:p
#         nextpnr:p
#         icestorm:p
#         prjtrellis:p
#
#   - name: 'âš™ï¸ git config'
#     run: git config --global core.autocrlf input
#     shell: bash
#
#   - name: 'ğŸ§° Checkout'
#     uses: actions/checkout@v5
#     with:
#       fetch-depth: 0
#       submodules: recursive
#
#   - name: 'ğŸš§ Generate ${{ matrix.board }} ${{ matrix.design }} bitstream'
#     run: make -C osflow BOARD=${{ matrix.board }} ${{ matrix.design }}
